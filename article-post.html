<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>撰寫文章 - Furry Café Map</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/heic2any@0.0.4/dist/heic2any.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: "Microsoft JhengHei", sans-serif; }
        body { background-color: #FFECCB; display: flex; justify-content: center; min-height: 100vh; overflow-x: hidden; }
        
        .container { width: 100%; max-width: 450px; padding: 20px; display: flex; flex-direction: column; gap: 15px; position: relative; }

        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .back-btn { width: 36px; height: 36px; border: 2.3px solid #333; border-radius: 50%; display: flex; justify-content: center; align-items: center; text-decoration: none; color: #333; }
        .post-btn { background-color: #FFB352; color: white; padding: 8px 25px; border-radius: 20px; border: none; font-weight: bold; cursor: pointer; font-size: 16px; }

        .title-section { display: flex; align-items: center; gap: 10px; font-size: 22px; color: #333; margin-top: 5px; }

        .social-group {
            display: flex;
            gap: 12px;
            margin: 10px 0 15px 0;
            overflow-x: auto;
            padding: 10px 0 15px 0;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .social-group::-webkit-scrollbar {
            display: none;
        }
        .social-item { position: relative; width: 60px; height: 60px; flex-shrink: 0; cursor: pointer; transition: all 0.3s ease; }
        .social-item.unbind { filter: grayscale(100%); opacity: 0.4; }
        .social-item.bind { filter: grayscale(0%); opacity: 1; transform: scale(1.05); }
        .avatar { width: 100%; height: 100%; background-color: #999; border-radius: 50%; display: flex; justify-content: center; align-items: center; overflow: hidden; border: 2px solid transparent; }
        .social-item.bind .avatar { border-color: #FFB352; }
        .avatar i { color: white; font-size: 35px; margin-top: 10px; } 
        .badge { position: absolute; bottom: 0; right: 0; width: 22px; height: 22px; border-radius: 50%; display: flex; justify-content: center; align-items: center; border: 2px solid white; font-size: 12px; color: white; }
        .badge.fb { background-color: #1877F2; }
        .badge.ig { background: linear-gradient(45deg, #f09433 0%, #bc1888 100%); }
        .badge.threads { background-color: #000; }
        .badge.x { background-color: #000; }
        .badge.bluesky { background-color: #0085ff; }

        /* 文章內容容器 */
        .post-content-wrapper { 
            background-color: white; 
            border-radius: 20px; 
            padding: 15px; 
            display: flex; 
            flex-direction: column; 
            min-height: 450px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); 
        }

        textarea {
            width: 100%;
            min-height: 150px;
            border: none;
            outline: none;
            resize: none;
            font-size: 17px;
            color: #333;
            line-height: 1.6;
            background: transparent;
            margin-bottom: 15px;
        }
        textarea::placeholder {
            color: #999;
        }

        .image-preview-container {
            width: 100%;
            display: none;
            position: relative;
            margin-top: auto;
            padding-top: 10px;
        }
        .preview-slider {
            display: flex;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            gap: 12px;
            margin-bottom: 10px;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .preview-slider::-webkit-scrollbar {
            display: none;
        }
        .preview-item {
            position: relative;
            flex: 0 0 calc(100% - 12px);
            min-width: calc(100% - 12px);
            aspect-ratio: 4/3;
            border-radius: 12px;
            overflow: hidden;
            background: #eee;
            scroll-snap-align: start;
            border: 2px solid transparent;
        }
        .preview-item.error {
            border: 2px solid #ff4444;
        }
        .preview-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 10px;
        }
        .remove-img-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(0,0,0,0.6);
            color: white;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            z-index: 10;
        }
        .photo-location-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 8px;
        }
        .photo-location-item {
            font-size: 12px;
            color: #666;
            padding: 8px 12px;
            background: #f8f8f8;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .photo-location-item.error {
            background: #ffe6e6;
            color: #ff4444;
            border: 1px solid #ff9999;
        }
        .photo-location-item i {
            color: #FFB352;
            font-size: 14px;
            flex-shrink: 0;
        }
        .photo-location-item.error i {
            color: #ff4444;
        }
        .location-delete-btn {
            margin-left: auto;
            background: rgba(255, 0, 0, 0.1);
            color: #ff4444;
            border: none;
            border-radius: 6px;
            padding: 4px 8px;
            font-size: 11px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s;
        }
        .location-delete-btn:hover {
            background: rgba(255, 0, 0, 0.2);
        }
        .error-message {
            font-size: 11px;
            color: #ff4444;
            margin-top: 4px;
            font-weight: 600;
        }

        /* 工具列 */
        .toolbar { display: flex; gap: 20px; padding-top: 15px; border-top: 1px solid #EEE; margin-top: 10px; }
        .tool-btn { font-size: 24px; color: #333; cursor: pointer; text-decoration: none; }

        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-box { background: white; width: 85%; max-width: 320px; border-radius: 25px; text-align: center; overflow: hidden; }
        .modal-body { padding: 30px 20px; }
        .modal-footer { display: flex; border-top: 1px solid #EEE; }
        .modal-footer button { flex: 1; padding: 15px; border: none; background: white; font-size: 16px; font-weight: bold; cursor: pointer; }
        .btn-confirm { color: white !important; background-color: #FFB352 !important; }
        .show { display: flex !important; }
    </style>
</head>
<body>

    <div class="container">
        <header class="header">
            <a href="index.html" class="back-btn"><i class="fa-solid fa-chevron-left"></i></a>
            <button class="post-btn" onclick="openModal()">發佈</button>
        </header>

        <div class="title-section"><i class="fa-solid fa-pen-nib"></i><strong>撰寫文章</strong></div>

        <div class="social-group">
            <div class="social-item" id="post-Facebook" onclick="togglePlatform('Facebook')">
                <div class="avatar"><i class="fa-solid fa-user"></i></div>
                <div class="badge fb"><i class="fa-brands fa-facebook-f"></i></div>
            </div>
            <div class="social-item" id="post-Instagram" onclick="togglePlatform('Instagram')">
                <div class="avatar"><i class="fa-solid fa-user"></i></div>
                <div class="badge ig"><i class="fa-brands fa-instagram"></i></div>
            </div>
            <div class="social-item" id="post-Threads" onclick="togglePlatform('Threads')">
                <div class="avatar"><i class="fa-solid fa-user"></i></div>
                <div class="badge threads"><i class="fa-solid fa-at"></i></div>
            </div>
            <div class="social-item" id="post-X" onclick="togglePlatform('X')">
                <div class="avatar"><i class="fa-solid fa-user"></i></div>
                <div class="badge x"><i class="fa-brands fa-x-twitter"></i></div>
            </div>
            <div class="social-item" id="post-BlueSky" onclick="togglePlatform('BlueSky')">
                <div class="avatar"><i class="fa-solid fa-user"></i></div>
                <div class="badge bluesky"><i class="fa-solid fa-republican"></i></div> 
            </div>
        </div>

        <div class="post-content-wrapper">
            <textarea id="articleContent" placeholder="[title] 輸入文章標題&#10;&#10;在此輸入文章內容..."></textarea>

            <div id="imagePreviewContainer" class="image-preview-container">
                <div class="preview-slider" id="previewSlider"></div>
                <div class="photo-location-list" id="photoLocationList"></div>
            </div>

            <div class="toolbar">
                <div class="tool-btn" onclick="goToAlbum()"><i class="fa-regular fa-image"></i></div>
                <div class="tool-btn" onclick="triggerCamera()"><i class="fa-solid fa-camera"></i></div>
                <a href="article-generate.html" class="tool-btn"><i class="fa-solid fa-wand-magic-sparkles"></i></a>
                <div class="tool-btn" onclick="undoContent()" title="復原" id="undoBtn"><i class="fa-solid fa-rotate-left"></i></div>
                <div class="tool-btn" onclick="redoContent()" title="重做" id="redoBtn" style="opacity: 0.4; cursor: not-allowed;"><i class="fa-solid fa-rotate-right"></i></div>
                <div class="tool-btn" onclick="resetContent()" title="清除全部"><i class="fa-solid fa-trash"></i></div>
            </div>
        </div>
    </div>

    <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display: none;">

    <div id="publishModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-body">確認發佈文章？</div>
            <div class="modal-footer">
                <button onclick="closeModal()">取消</button>
                <button class="btn-confirm" onclick="confirmPublish()">確認</button>
            </div>
        </div>
    </div>

    <script>
        const platforms = ['Facebook', 'Instagram', 'Threads', 'X', 'BlueSky'];
        const MAX_PHOTOS = 4;
        const MAX_DISTANCE_METERS = 500;

        let photos = [];

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function checkPhotoDistance(newLat, newLng) {
            if (photos.length === 0) return true;
            
            for (let photo of photos) {
                if (photo.lat && photo.lng) {
                    const distance = calculateDistance(photo.lat, photo.lng, newLat, newLng);
                    if (distance > MAX_DISTANCE_METERS) {
                        return false;
                    }
                }
            }
            return true;
        }

        window.onload = () => {
            initSocialIcons();
            loadDraftPhotos();
            
            setTimeout(() => {
                loadDraftContent();
                const currentContent = document.getElementById('articleContent').value;
                
                if (contentHistory.length === 0) {
                    if (currentContent) {
                        contentHistory = [currentContent];
                        historyIndex = 0;
                    } else {
                        contentHistory = [''];
                        historyIndex = 0;
                    }
                }
                updateUndoRedoButtons();
            }, 50);
        };

        window.addEventListener('focus', () => {
            loadDraftPhotos();
            const savedContent = localStorage.getItem('articleContent');
            if (savedContent) {
                const currentContent = document.getElementById('articleContent').value;
                // 只有当当前内容为空时才恢复保存的内容，避免覆盖用户正在输入的内容
                if (!currentContent || currentContent.trim() === '') {
                    if (contentHistory.length === 0) {
                        contentHistory = [savedContent];
                        historyIndex = 0;
                    } else if (contentHistory[contentHistory.length - 1] !== savedContent) {
                        contentHistory.push(savedContent);
                        historyIndex = contentHistory.length - 1;
                    }
                    document.getElementById('articleContent').value = savedContent;
                    updateUndoRedoButtons();
                } else {
                    // 如果当前有内容，更新 localStorage 保存当前内容
                    localStorage.setItem('articleContent', currentContent);
                }
            }
        });

        function loadDraftContent() {
            const content = localStorage.getItem('articleContent');
            if (content) {
                const currentValue = document.getElementById('articleContent').value;
                document.getElementById('articleContent').value = content;
                if (contentHistory.length === 0) {
                    if (currentValue && currentValue !== content) {
                        contentHistory = [currentValue, content];
                        historyIndex = 1;
                    } else {
                        contentHistory = [content];
                        historyIndex = 0;
                    }
                } else if (contentHistory[contentHistory.length - 1] !== content) {
                    if (currentValue && currentValue !== content && currentValue !== contentHistory[contentHistory.length - 1]) {
                        contentHistory.push(currentValue);
                    }
                    contentHistory.push(content);
                    historyIndex = contentHistory.length - 1;
                }
            }
        }

        function loadDraftPhotos() {
            const selectedPhotos = localStorage.getItem('selected_photos_for_article');
            if (selectedPhotos) {
                const photosToAdd = JSON.parse(selectedPhotos);
                photosToAdd.forEach(photo => {
                    const existingIndex = photos.findIndex(p => p.id === photo.id);
                    if (existingIndex === -1 && photos.length < MAX_PHOTOS) {
                        if (!photo.lat || !photo.lng) {
                            const baseLocation = photos.length > 0 && photos[0].lat ? 
                                { lat: photos[0].lat, lng: photos[0].lng } : 
                                { lat: 22.732775, lng: 120.288438 };
                            photo.lat = baseLocation.lat + (Math.random() - 0.5) * 0.002;
                            photo.lng = baseLocation.lng + (Math.random() - 0.5) * 0.002;
                        }
                        photos.push(photo);
                    }
                });
                if (photos.length === 4 && photos[3]) {
                    photos[3].lat = 25.0330;
                    photos[3].lng = 121.5654;
                }
                localStorage.removeItem('selected_photos_for_article');
                updatePreview();
                saveDraftPhotos();
            } else {
                const draft = localStorage.getItem('draft_photo');
                if (draft) {
                    const photo = JSON.parse(draft);
                    const existingIndex = photos.findIndex(p => p.id === photo.id);
                    if (existingIndex === -1) {
                        if (!photo.lat || !photo.lng) {
                            const baseLocation = photos.length > 0 && photos[0].lat ? 
                                { lat: photos[0].lat, lng: photos[0].lng } : 
                                { lat: 22.732775, lng: 120.288438 };
                            photo.lat = baseLocation.lat + (Math.random() - 0.5) * 0.002;
                            photo.lng = baseLocation.lng + (Math.random() - 0.5) * 0.002;
                        }
                        if (photos.length < MAX_PHOTOS) {
                            photos.push(photo);
                            if (photos.length === 4) {
                                photo.lat = 25.0330;
                                photo.lng = 121.5654;
                            }
                            updatePreview();
                            saveDraftPhotos();
                        } else {
                            alert(`最多只能上傳 ${MAX_PHOTOS} 張照片`);
                        }
                    }
                }
            }
        }

        function updatePreview() {
            const container = document.getElementById('imagePreviewContainer');
            const slider = document.getElementById('previewSlider');
            const locationList = document.getElementById('photoLocationList');
            
            if (photos.length === 0) {
                container.style.display = 'none';
                return;
            }
            
            container.style.display = 'block';
            slider.innerHTML = '';
            locationList.innerHTML = '';
            
            photos.forEach((photo, index) => {
                const isError = index === 3;
                const item = document.createElement('div');
                item.className = 'preview-item' + (isError ? ' error' : '');
                item.innerHTML = `
                    <img src="${photo.src}" class="preview-img" alt="照片${index + 1}">
                    <button class="remove-img-btn" onclick="removePhoto(${index})">✕</button>
                `;
                slider.appendChild(item);
                
                const locationItem = document.createElement('div');
                locationItem.className = 'photo-location-item' + (isError ? ' error' : '');
                if (isError) {
                    locationItem.innerHTML = `
                        <i class="fa-solid fa-triangle-exclamation"></i>
                        <div style="flex: 1;">
                            <div>照片 ${index + 1}: 緯度 ${photo.lat.toFixed(6)}, 經度 ${photo.lng.toFixed(6)}</div>
                            <div class="error-message">經緯度錯誤，請更換照片</div>
                        </div>
                        <button class="location-delete-btn" onclick="removePhoto(${index})">刪除</button>
                    `;
                } else {
                    locationItem.innerHTML = `
                        <i class="fa-solid fa-location-dot"></i>
                        <span style="flex: 1;">照片 ${index + 1}: 緯度 ${photo.lat.toFixed(6)}, 經度 ${photo.lng.toFixed(6)}</span>
                        <button class="location-delete-btn" onclick="removePhoto(${index})">刪除</button>
                    `;
                }
                locationList.appendChild(locationItem);
            });
        }

        function removePhoto(index) {
            photos.splice(index, 1);
            updatePreview();
            saveDraftPhotos();
        }

        function saveDraftPhotos() {
            if (photos.length > 0) {
                localStorage.setItem('draft_photo', JSON.stringify(photos[0]));
            } else {
                localStorage.removeItem('draft_photo');
            }
        }

        function goToAlbum() {
            // 保存当前内容到 localStorage，防止丢失
            const currentContent = document.getElementById('articleContent').value;
            if (currentContent) {
                localStorage.setItem('articleContent', currentContent);
            }
            localStorage.setItem('select_photo_for_article', 'true');
            window.location.href = 'photo.html';
        }

        // --- 相機與 HEIC 處理邏輯 ---
        const cameraInput = document.getElementById('cameraInput');

        function generateRandomLocation(baseLat, baseLng) {
            const offset = 0.001;
            return {
                lat: baseLat + (Math.random() - 0.5) * offset * 2,
                lng: baseLng + (Math.random() - 0.5) * offset * 2
            };
        }

        function triggerCamera() {
            // 保存当前内容到 localStorage，防止丢失
            const currentContent = document.getElementById('articleContent').value;
            if (currentContent) {
                localStorage.setItem('articleContent', currentContent);
            }
            
            const baseLocation = photos.length > 0 && photos[0].lat ? 
                { lat: photos[0].lat, lng: photos[0].lng } : 
                { lat: 22.732775, lng: 120.288438 };
            
            window.currentCapturePos = generateRandomLocation(baseLocation.lat, baseLocation.lng);
            cameraInput.click();
        }

        cameraInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            if (photos.length >= MAX_PHOTOS) {
                alert(`最多只能上傳 ${MAX_PHOTOS} 張照片`);
                e.target.value = '';
                return;
            }

            let blob = file;
            let capturedLocation = window.currentCapturePos;
            
            if (!capturedLocation) {
                const baseLocation = photos.length > 0 && photos[0].lat ? 
                    { lat: photos[0].lat, lng: photos[0].lng } : 
                    { lat: 22.732775, lng: 120.288438 };
                capturedLocation = generateRandomLocation(baseLocation.lat, baseLocation.lng);
            }

            if (photos.length > 0 && photos.length < 3 && !checkPhotoDistance(capturedLocation.lat, capturedLocation.lng)) {
                alert('照片位置距離太遠，請上傳相近位置的照片');
                e.target.value = '';
                return;
            }
            
            if (photos.length === 3) {
                capturedLocation = { lat: 25.0330, lng: 121.5654 };
            }
            
            if (file.type.includes("heic") || file.name.toLowerCase().endsWith(".heic")) {
                try {
                    blob = await heic2any({ blob: file, toType: "image/jpeg", quality: 0.7 });
                    if (Array.isArray(blob)) blob = blob[0];
                } catch (err) {
                    console.error("HEIC 轉換失敗", err);
                }
            }

            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const maxWidth = 1024;
                    let w = img.width, h = img.height;
                    if (w > maxWidth) { h = Math.round((h * maxWidth) / w); w = maxWidth; }
                    canvas.width = w; canvas.height = h;
                    canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                    
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                    
                    const newPhoto = {
                        src: dataUrl,
                        date: '今日',
                        id: Date.now(),
                        lat: capturedLocation.lat,
                        lng: capturedLocation.lng,
                        addr: '照片位置'
                    };
                    
                    if (photos.length === 3) {
                        newPhoto.lat = 25.0330;
                        newPhoto.lng = 121.5654;
                    }
                    
                    photos.push(newPhoto);
                    updatePreview();
                    saveDraftPhotos();

                    let allPhotos = JSON.parse(localStorage.getItem('all_photos') || '[]');
                    allPhotos.push(newPhoto);
                    localStorage.setItem('all_photos', JSON.stringify(allPhotos));
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(blob);
            e.target.value = '';
        });

        // --- 社交平台狀態邏輯 ---
        function initSocialIcons() {
            platforms.forEach(p => {
                const status = localStorage.getItem('social_' + p) || 'unbind';
                const el = document.getElementById('post-' + p);
                if (status === 'bind') { el.classList.add('bind'); el.classList.remove('unbind'); } 
                else { el.classList.add('unbind'); el.classList.remove('bind'); }
            });
        }

        function togglePlatform(p) {
            const currentStatus = localStorage.getItem('social_' + p) || 'unbind';
            localStorage.setItem('social_' + p, (currentStatus === 'bind') ? 'unbind' : 'bind');
            initSocialIcons();
        }

        function openModal() {
            document.getElementById('publishModal').classList.add('show');
        }
        
        function closeModal() {
            document.getElementById('publishModal').classList.remove('show');
        }
        function hasLocationError() {
            return photos.some((photo, index) => {
                if (index === 3) {
                    const baseLocation = photos.length > 0 && photos[0].lat ? 
                        { lat: photos[0].lat, lng: photos[0].lng } : 
                        { lat: 22.732775, lng: 120.288438 };
                    const distance = calculateDistance(baseLocation.lat, baseLocation.lng, photo.lat, photo.lng);
                    return distance > MAX_DISTANCE_METERS;
                }
                return false;
            });
        }

        function confirmPublish() {
            const content = document.getElementById('articleContent').value.trim();
            
            if (photos.length === 0) {
                alert('發佈文章必須要有照片！');
                return;
            }
            
            if (hasLocationError()) {
                alert('有照片的經緯度錯誤，請更換錯誤的照片後再發佈！');
                return;
            }
            
            if (!photos[0].lat || !photos[0].lng) {
                alert('發佈文章必須要有地點資訊！');
                return;
            }
            
            const articleData = {
                id: Date.now(),
                content: content,
                photos: photos,
                location: {
                    lat: photos[0].lat,
                    lng: photos[0].lng,
                    addr: '照片位置',
                    source: 'photo'
                },
                time: new Date().toISOString(),
                platforms: platforms.filter(p => localStorage.getItem('social_' + p) === 'bind'),
                heart: 0
            };
            
            let allArticles = JSON.parse(localStorage.getItem('all_articles') || '[]');
            allArticles.push(articleData);
            localStorage.setItem('all_articles', JSON.stringify(allArticles));
            
            alert('文章已同步發佈至選中平台！');
            photos = [];
            localStorage.removeItem('draft_photo');
            localStorage.removeItem('articleContent');
            localStorage.removeItem('article_restaurant');
            // 跳转到文章详情页，传递来源页面
            const urlParams = new URLSearchParams(window.location.search);
            const fromPage = urlParams.get('from') || 'article.html';
            window.location.href = `article-detail.html?id=${articleData.id}&from=${encodeURIComponent(fromPage)}`;
        }

        let contentHistory = [];
        let historyIndex = -1;
        let isUndoing = false;

        function undoContent() {
            if (historyIndex > 0) {
                const currentValue = document.getElementById('articleContent').value;
                if (historyIndex === contentHistory.length - 1 && contentHistory[historyIndex] !== currentValue) {
                    contentHistory.push(currentValue);
                }
                historyIndex--;
                isUndoing = true;
                document.getElementById('articleContent').value = contentHistory[historyIndex];
                updateUndoRedoButtons();
                setTimeout(() => { isUndoing = false; }, 100);
            } else {
                alert('沒有可復原的內容');
            }
        }

        function redoContent() {
            if (historyIndex < contentHistory.length - 1) {
                historyIndex++;
                isUndoing = true;
                document.getElementById('articleContent').value = contentHistory[historyIndex];
                updateUndoRedoButtons();
                setTimeout(() => { isUndoing = false; }, 100);
            } else {
                alert('沒有可重做的內容');
            }
        }

        function updateUndoRedoButtons() {
            const undoBtn = document.getElementById('undoBtn');
            const redoBtn = document.getElementById('redoBtn');
            
            if (historyIndex > 0) {
                undoBtn.style.opacity = '1';
                undoBtn.style.cursor = 'pointer';
            } else {
                undoBtn.style.opacity = '0.4';
                undoBtn.style.cursor = 'not-allowed';
            }
            
            if (historyIndex < contentHistory.length - 1) {
                redoBtn.style.opacity = '1';
                redoBtn.style.cursor = 'pointer';
            } else {
                redoBtn.style.opacity = '0.4';
                redoBtn.style.cursor = 'not-allowed';
            }
        }

        function resetContent() {
            if(confirm('確定清除內容與圖片？')) {
                document.getElementById('articleContent').value = '';
                localStorage.removeItem('articleContent');
                photos = [];
                contentHistory = [''];
                historyIndex = 0;
                updatePreview();
                saveDraftPhotos();
                updateUndoRedoButtons();
            }
        }

        const articleContentInput = document.getElementById('articleContent');
        let contentTimer = null;
        
        function saveToHistory(content) {
            if (isUndoing) return;
            
            if (historyIndex < contentHistory.length - 1) {
                contentHistory = contentHistory.slice(0, historyIndex + 1);
            }
            
            if (contentHistory.length === 0 || contentHistory[contentHistory.length - 1] !== content) {
                contentHistory.push(content);
                historyIndex = contentHistory.length - 1;
                
                if (contentHistory.length > 20) {
                    contentHistory.shift();
                    historyIndex--;
                }
                updateUndoRedoButtons();
            }
        }
        
        articleContentInput.addEventListener('input', function() {
            const currentContent = this.value;
            // 实时保存内容到 localStorage，防止丢失
            localStorage.setItem('articleContent', currentContent);
            if (contentTimer) clearTimeout(contentTimer);
            contentTimer = setTimeout(() => {
                saveToHistory(currentContent);
            }, 500);
        });
        
        // 第二个 focus 事件监听器已移除，避免重复处理
        

    </script>
</body>
</html>